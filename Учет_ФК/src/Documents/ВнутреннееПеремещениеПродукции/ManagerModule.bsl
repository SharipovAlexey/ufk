// СтандартныеПодсистемы.ВерсионированиеОбъектов
// Определяет настройки объекта для подсистемы ВерсионированиеОбъектов.
//
// Параметры:
// Настройки - Структура - настройки подсистемы.
Процедура ПриОпределенииНастроекВерсионированияОбъектов(Настройки) Экспорт
КонецПроцедуры
// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов

#Область ПрограммныйИнтерфейс
// Заполняет список команд печати.
// 
// Параметры:
//   КомандыПечати - ТаблицаЗначений - состав полей см. в функции УправлениеПечатью.СоздатьКоллекциюКомандПечати.
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "Накладная";
	КомандаПечати.Представление = НСтр("ru = 'Накладная ведомость'");
	КомандаПечати.Порядок       = 10;
	
КонецПроцедуры
#КонецОбласти

Функция НаименованиеСотрудникаДляВизы(Сотрудник)
	
	Если СтрДлина(СокрЛП(Сотрудник.ПредставлениеДляПечати))>0 Тогда
		Возврат СокрЛП(Сотрудник.ПредставлениеДляПечати);
	Иначе 
		Возврат СокрЛП(Сотрудник.Наименование);
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Накладная") Тогда 
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Накладная", "Накладная ведомость",
			СформироватьПечатнуюФормуНакладная(МассивОбъектов, ОбъектыПечати, ПараметрыПечати),,);
	КонецЕсли;
	
КонецПроцедуры

Функция СформироватьПечатнуюФормуНакладная(МассивОбъектов, ОбъектыПечати, ПараметрыПечати) Экспорт
	
	ТабличныйДокумент 							= Новый ТабличныйДокумент;
	ТабличныйДокумент.РазмерКолонтитулаСверху 	= 0;
	ТабличныйДокумент.РазмерКолонтитулаСнизу 	= 0;
	ТабличныйДокумент.ПолеСлева					= 25;
	ТабличныйДокумент.АвтоМасштаб 				= Истина;
	ТабличныйДокумент.ОриентацияСтраницы 		= ОриентацияСтраницы.Портрет;
	
	ТабличныйДокумент.КлючПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ВнутреннееПеремещение_Накладная";

	Макет = УправлениеПечатью.МакетПечатнойФормы("Документ.ВнутреннееПеремещениеПродукции.Накладная");
	
	ОбластьШапка		= Макет.ПолучитьОбласть("Шапка");
	ОбластьЗаголовок	= Макет.ПолучитьОбласть("Заголовок");
	ОбластьСтрока		= Макет.ПолучитьОбласть("Строка");
	ОбластьИтого		= Макет.ПолучитьОбласть("Итого");
	ОбластьПодвала 		= Макет.ПолучитьОбласть("Подвал");
	   	
	Для Каждого СсылкаНаОбъект Из МассивОбъектов Цикл 
		
		СтруктураДанныхДляПечати = новый Структура;
		СтруктураДанныхДляПечати.Вставить("НаименованиеОрганизации",		pm_ОбщегоНазначения.ОписаниеОрганизации(СсылкаНаОбъект.Организация,"НаименованиеПолное"));
		СтруктураДанныхДляПечати.Вставить("ДатаОтгрузки",					СсылкаНаОбъект.Дата);
		СтруктураДанныхДляПечати.Вставить("СкладОтправитель",				СсылкаНаОбъект.Склад.Наименование);
		СтруктураДанныхДляПечати.Вставить("СкладПолучатель",				СсылкаНаОбъект.СкладПолучатель.Наименование);
		СтруктураДанныхДляПечати.Вставить("РеквизитыДокумента",				"№ "+СсылкаНаОбъект.Номер+" от "+Формат(СсылкаНаОбъект.Дата,"ДЛФ=ДД"));	
		
		ОбластьШапка.Параметры.Заполнить(СтруктураДанныхДляПечати);
		ТабличныйДокумент.Вывести(ОбластьШапка);
		ТабличныйДокумент.Вывести(ОбластьЗаголовок);
		 
		ТабличнаяЧасть 		= СсылкаНаОбъект.Продукция;
		КоличествоМешков	= ТабличнаяЧасть.Количество();
		ИтогоВес 			= 0;
		Ном 				= 0;
		
		Для Каждого СтрокаТаб Из ТабличнаяЧасть Цикл
			
			ТекущаяПартия	= СтрокаТаб.ПартияПродукции;
			ИтогоВес		= ИтогоВес+СтрокаТаб.ВесБруттоВлажный;
			Ном 			= Ном+1;
			
			СтруктураДанныхДляПечати = новый Структура;
			СтруктураДанныхДляПечати.Вставить("Ном",			Ном);
			СтруктураДанныхДляПечати.Вставить("НаименованиеФК",	ТекущаяПартия.Номенклатура.ПолноеНаименование);
			СтруктураДанныхДляПечати.Вставить("НомПартии",		ТекущаяПартия.Код);
			СтруктураДанныхДляПечати.Вставить("НомМешка",		ПолучитьМестоВПартииНаСервере(Новый Структура("НомерМестаВПартии,ТранспортировочноеМесто",0,СтрокаТаб.ТранспортировочноеМесто)));	
			СтруктураДанныхДляПечати.Вставить("Вес",			СтрокаТаб.ВесБруттоВлажный);
			
			ОбластьСтрока.Параметры.Заполнить(СтруктураДанныхДляПечати);
			ТабличныйДокумент.Вывести(ОбластьСтрока);

		КонецЦикла;
		
		СтруктураДанныхДляПечати = новый Структура;
		СтруктураДанныхДляПечати.Вставить("КолМешков",	КоличествоМешков);
		СтруктураДанныхДляПечати.Вставить("ИтогоВес",	ИтогоВес);
		
		ОбластьИтого.Параметры.Заполнить(СтруктураДанныхДляПечати);
		ТабличныйДокумент.Вывести(ОбластьИтого);
		
		СтруктураДанныхДляПечати = новый Структура;
		СтруктураДанныхДляПечати.Вставить("ФИООтпустил",		НаименованиеСотрудникаДляВизы(СсылкаНаОбъект.ВизаОтправителя));
		СтруктураДанныхДляПечати.Вставить("ДолжностьОтпустил",	СсылкаНаОбъект.ВизаОтправителя.Должность.Наименование);
		                                                    
		ОбластьПодвала.Параметры.Заполнить(СтруктураДанныхДляПечати);

		ТабличныйДокумент.Вывести(ОбластьПодвала);
				
	КонецЦикла;
		
	ТабличныйДокумент.ТолькоПросмотр = Истина;
	Возврат ТабличныйДокумент;

КонецФункции

Функция ПолучитьМестоВПартииНаСервере(СтруктураДанных)
	
	Если СтруктураДанных.ТранспортировочноеМесто.Пустая() Тогда 
		Возврат "";
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДанныеЗатаркиТранспортировочныхМест.НомерМеста КАК НомерМеста
		|ИЗ
		|	РегистрСведений.ДанныеЗатаркиТранспортировочныхМест КАК ДанныеЗатаркиТранспортировочныхМест
		|ГДЕ
		|	ДанныеЗатаркиТранспортировочныхМест.ТранспортировочноеМесто = &ТранспортировочноеМесто";
	
	Запрос.УстановитьПараметр("ТранспортировочноеМесто", СтруктураДанных.ТранспортировочноеМесто);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		СтруктураДанных.НомерМестаВПартии 	= ВыборкаДетальныеЗаписи.НомерМеста;
	КонецЕсли;
	
	Возврат СтруктураДанных.НомерМестаВПартии;
	
КонецФункции

